<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DreamTV Streaming — Melhorado</title>
  <!-- React UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HLS.js para m3u8 no Chrome/Firefox/Edge -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <style>
    html,body{margin:0;height:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,system-ui,sans-serif}
    .star-bg{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f1419 100%);position:relative;overflow:hidden}
    .star-bg::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:0;background-image:radial-gradient(2px 2px at 20px 30px,#fff,transparent),radial-gradient(2px 2px at 60px 70px,#fff,transparent),radial-gradient(1px 1px at 50px 50px,#fff,transparent),radial-gradient(1px 1px at 130px 80px,#fff,transparent),radial-gradient(2px 2px at 90px 10px,#fff,transparent);background-repeat:repeat;background-size:200px 200px;opacity:.3;animation:twinkle 3s infinite}
    @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:.5}}
    .gradient-text{background:linear-gradient(90deg,#a855f7,#ec4899,#3b82f6);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .frost{background:rgba(30,30,30,.72);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08)}
    .card{transition:transform .2s ease,background .2s ease}
    .card:hover{transform:translateY(-2px)}
    .no-tap-highlight{-webkit-tap-highlight-color:transparent}
    .text-shadow{text-shadow:0 0 18px rgba(168,85,247,.35)}
    video{max-height:80vh}
    .hint{font-size:11px}
  </style>
</head>
<body class="no-tap-highlight">
  <div id="app"></div>

  <script>
  'use strict'
  const e = React.createElement
  const { useState, useEffect, useMemo, useRef } = React

  // ===== Helpers =====
  function useLocalStorage(key, initial){
    const [val,setVal] = useState(()=>{
      try{ const v = localStorage.getItem(key); return v? JSON.parse(v): initial }catch{ return initial }
    })
    useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(val)) }catch{} }, [key,val])
    return [val,setVal]
  }

  function sanitizeServer(url){ if(!url) return '';
    const u = url.trim().replace(/\/$/,'')
    if(!/^https?:\/\//i.test(u)) return 'http://' + u
    return u
  }

  function buildURL(base, pathSegs){
    const b = sanitizeServer(base)
    return [b, ...pathSegs.map(s=>String(s).replace(/^\/+|\/+$/g,''))].join('/')
  }

  function maskUrlCredentials(url){
    try{
      const u = new URL(url)
      const qs = u.search.replace(/(username=)([^&]+)/i, '$1***').replace(/(password=)([^&]+)/i, '$1***')
      const path = u.pathname.replace(/\/(live|movie|series)\/([^/]+)\/([^/]+)\//i, '/$1/***/***/')
      return `${u.origin}${path}${qs}`
    }catch{ return url.replace(/(username=)([^&]+)/i, '$1***').replace(/(password=)([^&]+)/i, '$1***') }
  }

  function formatEPGTime(v){
    if(v==null) return '--:--'
    if(typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)) return v
    const n = Number(v)
    if(!isNaN(n)){
      const ms = n > 1e12 ? n : (n > 1e10 ? n : n*1000)
      const d = new Date(ms)
      const hh = String(d.getHours()).padStart(2,'0')
      const mm = String(d.getMinutes()).padStart(2,'0')
      return `${hh}:${mm}`
    }
    return '--:--'
  }

  // Normalizadores para respostas de painéis que não retornam Arrays puros
  function toArray(x){
    if(Array.isArray(x)) return x
    if(x && typeof x==='object'){
      return Object.values(x)
    }
    return []
  }
  function getCatId(cat){
    return cat?.category_id ?? cat?.parent_id ?? cat?.id ?? cat?.CategoryID ?? cat?.categoryid ?? null
  }

  // Encapsula proxy opcional para contornar CORS (uso consciente)
  function wrapProxy(url, enabled){
    return enabled ? ('https://api.allorigins.win/raw?url=' + encodeURIComponent(url)) : url
  }

  function App(){
    const [view,setView] = useState('home')
    const [account,setAccount] = useState(null)
    const [loading,setLoading] = useState(false)
    const [error,setError] = useState('')
    const [debug,setDebug] = useState(null)

    const [cfg,setCfg] = useLocalStorage('xtream_config', { server:'', username:'', password:'' })
    const [useProxy,setUseProxy] = useLocalStorage('xtream_use_proxy', false)

    const [liveCats,setLiveCats] = useState([])
    const [vodCats,setVodCats] = useState([])
    const [seriesCats,setSeriesCats] = useState([])

    // TV ao vivo
    const [selectedLiveCat,setSelectedLiveCat] = useState(null)
    const [liveStreams,setLiveStreams] = useState([])
    const [selectedChannel,setSelectedChannel] = useState(null)
    const [epg,setEpg] = useState([])
    const [liveLeftMode,setLiveLeftMode] = useState('categories')
    const autoOpenLiveRef = useRef(false)

    // Genérico
    const [selectedCat,setSelectedCat] = useState(null)
    const [items,setItems] = useState([])
    const [query,setQuery] = useState('')

    const [current,setCurrent] = useState(null)

    // ==== API ====
    async function parseJsonFromResponse(res){
      const ct = (res.headers.get('content-type')||'').toLowerCase()
      if(ct.includes('application/json')) return res.json()
      const text = await res.text()
      try{ return JSON.parse(text) }catch{ throw new Error('Resposta não-JSON da API') }
    }

    async function apiCall(action, params){
      const server = sanitizeServer(cfg.server)
      if(!server || !cfg.username || !cfg.password){ throw new Error('Configuração incompleta') }
      const usp = new URLSearchParams({ username:cfg.username, password:cfg.password, action, ...(params||{}) })
      const url = server + '/player_api.php?' + usp.toString()
      setDebug({ url })
      let res
      try{ res = await fetch(wrapProxy(url, useProxy), { headers:{ 'Accept':'application/json' } }) }
      catch{ throw new Error('Falha de rede/CORS') }
      if(!res.ok) throw new Error('HTTP ' + res.status)
      try{ return await parseJsonFromResponse(res) }catch{ throw new Error('Resposta inválida da API') }
    }

    async function fetchAccountInfo(){
      const server = sanitizeServer(cfg.server)
      if(!server || !cfg.username || !cfg.password){ throw new Error('Configuração incompleta') }
      const qs = new URLSearchParams({ username:cfg.username, password:cfg.password })
      const url1 = server + '/player_api.php?' + qs.toString() + '&action=get_account_info'
      const url2 = server + '/player_api.php?' + qs.toString()

      async function tryOne(url){
        setDebug({ url })
        let res
        try{ res = await fetch(wrapProxy(url, useProxy), { headers:{ 'Accept':'application/json' } }) }
        catch{ throw new Error('Falha de rede/CORS') }
        if(!res.ok) throw new Error('HTTP ' + res.status)
        return await parseJsonFromResponse(res)
      }

      try{ return await tryOne(url1) }
      catch(e1){
        try{ return await tryOne(url2) }
        catch(e2){ throw new Error(e2.message || e1.message || 'Falha ao autenticar') }
      }
    }

    function explainLoginError(msg){
      if(/cors|network|falha de rede/i.test(msg)) return 'O painel bloqueou requisições do navegador (CORS) OU o DNS/porta está errado/fora do ar.'
      if(/401|403/.test(msg)) return 'Usuário/senha incorretos ou bloqueados.'
      if(/404/.test(msg)) return 'Endpoint /player_api.php não encontrado nesse DNS/porta.'
      if(/Resposta não-JSON|Resposta inválida/i.test(msg)) return 'Formato de resposta inesperado para a API.'
      return 'Não foi possível autenticar com essas credenciais/URL.'
    }

    // Carregamento pontual por seção
    async function loadCatsByType(type){
      try{
        if(type==='live'){
          const raw = await apiCall('get_live_categories')
          setLiveCats(toArray(raw))
        }else if(type==='vod'){
          const raw = await apiCall('get_vod_categories')
          setVodCats(toArray(raw))
        }else{
          const raw = await apiCall('get_series_categories')
          setSeriesCats(toArray(raw))
        }
      }catch(err){ setError(err.message) }
    }

    // Só busca quando a view entrar
    useEffect(()=>{
      if(view==='live-categories' && liveCats.length===0) { autoOpenLiveRef.current = false; loadCatsByType('live') }
      if(view==='movie-categories' && vodCats.length===0) loadCatsByType('vod')
      if(view==='series-categories' && seriesCats.length===0) loadCatsByType('series')
    }, [view])

    // Ao carregar as categorias do Live, abre a primeira (se houver), uma vez por entrada
    useEffect(()=>{
      if(view==='live-categories' && liveCats.length>0 && !selectedLiveCat && !autoOpenLiveRef.current){
        autoOpenLiveRef.current = true
        ;(async()=>{ try{ await openLiveCategory(liveCats[0], false) }catch(e){} })()
      }
    }, [view, liveCats, selectedLiveCat])

    // reset da flag ao sair da view
    useEffect(()=>{ if(view!=='live-categories') autoOpenLiveRef.current = false }, [view])

    useEffect(()=>{ // autoload se já tiver config
      if(cfg.server && cfg.username && cfg.password){
        setError('')
        fetchAccountInfo().then(info=> setAccount(info.user_info||info)).catch(err=> setError(explainLoginError(err.message||String(err))))
      }
    },[])

    function onConnect(){
      if(!cfg.server || !cfg.username || !cfg.password){ setError('Preencha Servidor/Usuário/Senha.'); return }
      setCfg(v=>({ ...v, server:sanitizeServer(v.server) }));
      setAccount(null); setError('')
      setView('home')
    }

    function onLogout(){ setAccount(null); setLiveCats([]); setVodCats([]); setSeriesCats([]); setItems([]); setCurrent(null); setSelectedCat(null); setSelectedLiveCat(null); setLiveStreams([]); setEpg([]); setView('home') }

    async function openCategory(cat, type){
      setSelectedCat({ ...cat, type }); setItems([]); setQuery(''); setView('channels'); setLoading(true)
      try{
        if(type==='live'){
          const data = await apiCall('get_live_streams', { category_id: getCatId(cat) })
          setItems(toArray(data))
        }else if(type==='vod'){
          const data = await apiCall('get_vod_streams', { category_id: getCatId(cat) })
          setItems(toArray(data))
        }else{ // series -> lista de séries
          const data = await apiCall('get_series', { category_id: getCatId(cat) })
          setItems(toArray(data))
        }
      }catch(err){ setError(err.message) }
      finally{ setLoading(false) }
    }

    // ===== TV AO VIVO =====
    async function openLiveCategory(cat, switchLeft = true){
      try{
        setLoading(true)
        setSelectedLiveCat(cat)
        const catId = getCatId(cat)
        if(!catId){ setLiveStreams([]); setSelectedChannel(null); setEpg([]); return }
        const data = await apiCall('get_live_streams', { category_id: catId })
        const list = toArray(data)
        setLiveStreams(list)
        if(list.length>0){
          setSelectedChannel(list[0])
          await loadEpg(list[0].stream_id || list[0].id)
        }else{ setSelectedChannel(null); setEpg([]) }
        if(switchLeft) setLiveLeftMode('channels')
      }catch(err){ setError(err.message); setLiveStreams([]) }
      finally{ setLoading(false) }
    }

    async function loadEpg(streamId){
      try{
        const data = await apiCall('get_short_epg', { stream_id: streamId, limit: 6 })
        const list = Array.isArray(data) ? data : (data && Array.isArray(data.epg_listings) ? data.epg_listings : [])
        const norm = toArray(list).map((it,idx)=>({
          id: it.id || it.event_id || idx,
          title: it.title || 'Programa não encontrado',
          start: formatEPGTime(it.start || it.start_time || it.start_timestamp),
          end: formatEPGTime(it.end || it.end_time || it.end_timestamp)
        }))
        setEpg(norm)
      }catch{ setEpg([]) }
    }

    async function playStream(item){
      try{
        let url = ''
        let isHls = false
        const id = item.stream_id || item.series_id || item.id

        if(selectedCat?.type==='live'){
          url = buildURL(cfg.server, ['live', cfg.username, cfg.password, id + '.m3u8'])
          isHls = true
        }else if(selectedCat?.type==='vod'){
          const ext = (item.container_extension || 'mp4').replace(/\.+/,'')
          url = buildURL(cfg.server, ['movie', cfg.username, cfg.password, id + '.' + ext])
          isHls = /m3u8/i.test(ext)
        }else{ // séries: precisamos buscar episódios primeiro
          const sInfo = await apiCall('get_series_info', { series_id: id })
          const seasons = (sInfo.episodes && typeof sInfo.episodes === 'object') ? sInfo.episodes : {}
          const firstSeason = Object.keys(seasons).sort((a,b)=>Number(a)-Number(b))[0]
          const eps = seasons[firstSeason] || []
          const ep = eps[0]
          if(!ep) throw new Error('Sem episódios disponíveis para esta série')
          const epId = ep.id || ep.episode_id || ep.stream_id || id
          const ext = (ep.container_extension || 'mp4').replace(/\.+/,'')
          url = buildURL(cfg.server, ['series', cfg.username, cfg.password, epId + '.' + ext])
          isHls = /m3u8/i.test(ext)
        }
        setCurrent({ name: item.name || item.title || 'Reprodução', url, isHls })
        setView('player')
      }catch(err){ setError(err.message) }
    }

    const filtered = useMemo(()=>{
      const q = query.trim().toLowerCase()
      if(!q) return items
      return items.filter(it=> (it.name||it.title||'').toLowerCase().includes(q))
    }, [items, query])

    // ===== UI =====
    function TopBar(){
      return e('div', { className:'flex items-center justify-between p-4 bg-black/40 frost' },
        e('div', { className:'flex items-center gap-2' },
          e('span', { className:'text-white text-xl font-bold gradient-text' }, 'DREAMTV'),
          account? e('span', { className:'text-xs text-gray-400' }, 'Status: ', e('b',{className: account.status==='Active'?'text-green-400':'text-red-400'}, account.status||'N/A')): null
        ),
        e('div', { className:'flex items-center gap-2' },
          e('button', { onClick:()=>setView('config'), className:'px-3 py-2 rounded-lg text-white bg-zinc-700 hover:bg-zinc-600 text-sm'}, 'Configurações'),
          account? e('button', { onClick:onLogout, className:'px-3 py-2 rounded-lg text-white bg-zinc-800 hover:bg-zinc-700 text-sm'}, 'Sair'): null
        )
      )
    }

    function Home(){
      return e('div', { className:'star-bg min-h-screen flex flex-col items-center justify-center p-8' },
        e('div', { className:'mb-16 text-center' },
          e('h1', { className:'text-6xl font-extrabold gradient-text text-shadow mb-2' }, 'DREAMTV'),
          e('p', { className:'text-gray-400 tracking-widest' }, 'STREAMING')
        ),
        e('div', { className:'flex flex-wrap justify-center gap-12 mb-16' },
          e('div', { onClick:()=>setView('live-categories'), className:'flex flex-col items-center cursor-pointer opacity-80 hover:opacity-100 card', role:'button', tabIndex:0, onKeyDown:(ev)=>{ if(ev.key==='Enter'||ev.key===' ') setView('live-categories') } },
            e('div', { className:'w-24 h-24 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shadow-lg shadow-purple-500/50' }, e('span', { className:'text-4xl' }, '📺')),
            e('span',{className:'text-white mt-3 text-sm font-medium'}, 'TV ao vivo')
          ),
          e('div', { onClick:()=>setView('movie-categories'), className:'flex flex-col items-center cursor-pointer opacity-80 hover:opacity-100 card' },
            e('div', { className:'w-24 h-24 rounded-full bg-zinc-700/60 flex items-center justify-center' }, e('span', { className:'text-4xl' }, '🎬')),
            e('span',{className:'text-white mt-3 text-sm font-medium'}, 'Filmes')
          ),
          e('div', { onClick:()=>setView('series-categories'), className:'flex flex-col items-center cursor-pointer opacity-80 hover:opacity-100 card' },
            e('div', { className:'w-24 h-24 rounded-full bg-zinc-700/60 flex items-center justify-center' }, e('span', { className:'text-4xl' }, '🎭')),
            e('span',{className:'text-white mt-3 text-sm font-medium'}, 'Séries')
          )
        ),
        e('div', { className:'flex flex-col md:flex-row items-center gap-3' },
          e('button', { onClick: ()=>{ setError(''); setDebug(null) }, className:'bg-zinc-700/70 border border-zinc-600 text-white px-6 py-3 rounded-full hover:bg-zinc-600 transition-all' }, '🔄 Limpar aviso'),
          e('label', { className:'text-white/80 text-xs flex items-center gap-2' },
            e('input', { type:'checkbox', checked:useProxy, onChange:(ev)=>setUseProxy(!!ev.target.checked) }),
            'Usar proxy CORS (AllOrigins) — pode expor as credenciais ao serviço proxy'
          ),
          !account && e('button', { onClick:()=>setView('config'), className:'bg-purple-600 text-white px-6 py-3 rounded-full hover:bg-purple-500 transition-all' }, 'Configurar')
        ),
        error && e('div', { className:'mt-6 text-red-300 text-sm' }, 'Erro: ', error, debug? e('div', {className:'hint text-gray-400 mt-1'}, 'URL: ', maskUrlCredentials(debug.url||'')) : null),
        e('div', { className:'absolute bottom-6 left-6 text-gray-400 text-xs' },
          e('div', null, 'Versão: 2.4.0'),
          account && e('div', null, 'Usuário: ' + (account.username||''))
        )
      )
    }

    function Categories(){
      const isLive = view==='live-categories'
      if(isLive){
        const totalAll = (liveCats||[]).reduce((acc,c)=> acc + (Number(c.total)||0), 0)
        return e('div', { className:'star-bg min-h-screen p-4 md:p-6 relative' },
          e(TopBar),
          e('div', { className:'grid grid-cols-12 gap-4 mt-4' },
            // Esquerda: categorias ou canais
            e('div', { className:'col-span-12 md:col-span-3 space-y-3' },
              e('div', { className:'frost rounded-lg px-4 py-3 flex items-center justify-between' },
                e('button', { className:'flex items-center gap-3 text-white font-semibold', onClick:()=> setLiveLeftMode('categories') },
                  e('span', { className:'text-xl' }, '▦'),
                  liveLeftMode==='categories' ? 'Todos' : (selectedLiveCat?.category_name || 'Categoria')
                ),
                e('span', { className:'text-gray-300 font-bold' }, String(liveLeftMode==='categories' ? totalAll : (liveStreams?.length||0)))
              ),
              error && e('div', { className:'text-red-300 text-xs' }, 'Live: ', error, !useProxy ? e('button', { onClick:()=>setUseProxy(true), className:'underline ml-2 text-[11px] text-white/80' }, 'Tentar via Proxy') : null),
              liveLeftMode==='categories' ?
                toArray(liveCats).map(cat=> {
                  const catId = getCatId(cat)
                  return e('button', { key:catId||cat.category_name, onClick:()=>openLiveCategory(cat, true), className:'w-full rounded-lg px-4 py-3 text-left frost hover:border-purple-400/40 ' + (selectedLiveCat && getCatId(selectedLiveCat)===catId? ' ring-2 ring-white/70 bg-white/10 text-white':' text-white/90') },
                    e('div', { className:'flex items-center justify-between' },
                      e('span', { className:'truncate font-semibold' }, cat.category_name||'Sem nome'),
                      e('span', { className:'opacity-80 ml-3' }, String(cat.total||0))
                    )
                  )
                })
              :
                toArray(liveStreams).map(item=> {
                  const key = item.stream_id || item.id || item.name
                  const isSel = (selectedChannel && ((selectedChannel.stream_id||selectedChannel.id)===(item.stream_id||item.id)))
                  return e('button', { key, onClick:()=>{ setSelectedChannel(item); loadEpg(item.stream_id||item.id) }, className:'w-full rounded-lg px-3 py-3 text-left frost hover:border-purple-400/40 ' + (isSel ? ' ring-2 ring-white/70 bg-white/10 text-white':' text-white/90') },
                    e('div', { className:'flex items-center gap-3' },
                      e('div', { className:'min-w-[48px] text-center font-bold opacity-90' }, String(item.stream_id||item.id||'')),
                      item.stream_icon ? e('img', { src:item.stream_icon, className:'w-8 h-8 object-contain rounded', alt:'' }) : e('div', { className:'w-8 h-8 rounded bg-zinc-600 grid place-items-center text-xs' }, 'TV'),
                      e('div', { className:'truncate font-semibold' }, item.name||'Sem título')
                    )
                  )
                })
            ),
            // Centro: player + info + EPG
            e('div', { className:'col-span-12 md:col-span-6 space-y-3' },
              e('div', { className:'relative rounded-lg overflow-hidden bg-black aspect-video frost' },
                e(LiveVideo, { channel:selectedChannel, onDbl:()=>toggleFullscreen('#liveVideo') })
              ),
              e('div', { className:'-mt-2 px-4 py-3 rounded-lg frost text-white flex items-center gap-4' },
                e('span', { className:'text-lg font-bold' }, selectedChannel? String(selectedChannel.stream_id||selectedChannel.id||'') : '—'),
                e('span', { className:'opacity-80' }, '📺'),
                e('div', { className:'font-semibold truncate' }, selectedChannel? (selectedChannel.name||'') : 'Selecione um canal')
              ),
              e('div', { className:'space-y-3' },
                (epg && epg.length>0 ? epg : Array.from({length:4}).map((_,i)=>({ id:'empty'+i, title:'Programa não encontrado', start:'--:--', end:'--:--' }))).map((pg,i)=>
                  e('div', { key:pg.id||i, className:'frost rounded-lg px-4 py-3 flex items-center justify-between text-white' },
                    e('div', { className:'flex items-center gap-3' },
                      e('span', { className:'w-3 h-3 rounded-full bg-gray-400 inline-block' }),
                      e('div', null,
                        e('div', { className:'font-semibold' }, pg.title||'Programa não encontrado')
                      )
                    ),
                    e('div', { className:'text-sm text-gray-300' }, (pg.start||'--:--') + ' : ' + (pg.end||'--:--'))
                  )
                )
              )
            ),
            // Direita: datas
            e('div', { className:'col-span-12 md:col-span-3 space-y-3' },
              [0,1,2,3,4,5,6].map((off)=> e('div', { key:off, className:'rounded-lg frost text-white px-4 py-6 text-center' },
                e('div', { className:'text-2xl font-bold' }, dayNum(off)),
                e('div', { className:'opacity-75' }, dayWeek(off))
              ))
            )
          )
        )
      }

      // Filmes/Séries genéricos
      const cats = view==='movie-categories'? vodCats : seriesCats
      const title = view==='movie-categories'? 'Filmes — Categorias' : 'Séries — Categorias'
      const type = view==='movie-categories'? 'vod' : 'series'
      return e('div', { className:'star-bg min-h-screen p-6' },
        e(TopBar),
        e('div', { className:'flex items-center gap-3 mt-4 mb-4' },
          e('button', { onClick:()=>setView('home'), className:'text-white text-xl hover:text-purple-400' }, '←'),
          e('h2', { className:'text-white text-2xl font-bold' }, title)
        ),
        cats && cats.length>0 ? e('div', { className:'grid grid-cols-1 gap-3 max-w-2xl' },
          toArray(cats).map(cat=> e('button', { key:getCatId(cat)||cat.category_name, onClick:()=>openCategory(cat, type), className:'frost rounded-lg p-4 flex items-center justify-between text-left text-white hover:border-purple-400/50' },
            e('div', { className:'flex items-center gap-4' },
              e('div', { className:'w-12 h-12 bg-zinc-700 rounded-lg grid place-items-center' }, e('span', { className:'text-2xl' }, '📁')),
              e('span', { className:'text-lg font-medium truncate' }, cat.category_name || 'Sem nome')
            ),
            e('span', { className:'text-gray-300 text-lg font-bold' }, String(cat.total || 0))
          ))
        ) : e('div', { className:'text-center text-gray-400 mt-12 flex flex-col items-center gap-4' },
          'Sem categorias',
          error ? e('div', { className:'text-red-300 text-sm' }, 'Erro: ', error, debug? e('div', {className:'hint text-gray-400 mt-1'}, 'URL: ', maskUrlCredentials(debug.url||'')) : null) : null
        )
      )
    }

    function LiveVideo({ channel, onDbl }){
      const vref = useRef(null)
      useEffect(()=>{
        const v = vref.current
        if(!v) return
        if(!channel){ v.removeAttribute('src'); v.load(); return }
        const url = buildURL(cfg.server, ['live', cfg.username, cfg.password, (channel.stream_id||channel.id)+'.m3u8'])
        const canNative = v.canPlayType('application/vnd.apple.mpegURL')
        if(window.Hls && window.Hls.isSupported() && !canNative){
          const h = new Hls({ maxBufferLength:30 })
          h.loadSource(url); h.attachMedia(v)
        }else{ v.src = url }
        v.play().catch(()=>{})
      }, [channel])

      return e('video', {
        id:'liveVideo', ref:vref, className:'w-full h-full', controls:true, playsInline:true,
        onDoubleClick: onDbl,
        onClick:()=>{
          const v = vref.current; if(!v) return; if(v.paused) v.play(); else v.pause();
        }
      })
    }

    function toggleFullscreen(sel){
      const el = document.querySelector(sel)
      if(!el) return
      if(document.fullscreenElement){ document.exitFullscreen().catch(()=>{}) }
      else{ el.requestFullscreen && el.requestFullscreen().catch(()=>{}) }
    }

    function dayNum(offset){ const d = new Date(); d.setDate(d.getDate()+offset); return String(d.getDate()).padStart(2,'0') }
    function dayWeek(offset){ const d = new Date(); d.setDate(d.getDate()+offset); return ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][d.getDay()] }

    function Channels(){
      return e('div', { className:'star-bg min-h-screen p-6' },
        e(TopBar),
        e('div', { className:'flex flex-wrap items-center gap-3 mt-4 mb-4' },
          e('button', { onClick:()=> setView(selectedCat.type==='live'?'live-categories': selectedCat.type==='vod'?'movie-categories':'series-categories'), className:'text-white text-xl hover:text-purple-400' }, '←'),
          e('h2', { className:'text-white text-2xl font-bold' }, selectedCat?.category_name || 'Categoria'),
          e('div', { className:'grow' }),
          e('input', { value:query, onChange:(ev)=>setQuery(ev.target.value), placeholder:'Pesquisar...', className:'w-full md:w-72 frost rounded-lg px-4 py-2 text-white placeholder:text-gray-400' })
        ),
        error && e('div', { className:'text-red-300 mb-3' }, 'Erro: ', error),
        e('div', { className:'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4' },
          filtered && filtered.length>0 ?
            filtered.map(item=> e('button', { key:item.stream_id || item.series_id || item.id || item.title, onClick:()=>playStream(item), className:'rounded-lg frost p-3 text-left card' },
              item.stream_icon ? e('img', { src:item.stream_icon, alt:item.name, loading:'lazy', className:'w-full h-32 object-cover rounded mb-3' })
                                : e('div', { className:'w-full h-32 bg-gradient-to-br from-purple-500 to-blue-500 rounded mb-3 grid place-items-center text-3xl' }, '▶️'),
              e('div', { className:'text-white text-sm font-medium truncate' }, item.name || item.title || 'Sem título')
            ))
          : e('div', { className:'text-center text-gray-400 col-span-full mt-12' }, 'Nenhum conteúdo nesta categoria')
        )
      )
    }

    function Player(){
      const videoRef = useRef(null)
      const [hlsObj,setHlsObj] = useState(null)

      useEffect(()=>{ return ()=>{ if(hlsObj){ try{ hlsObj.destroy() }catch{} } } },[hlsObj])

      useEffect(()=>{
        const v = videoRef.current
        if(!v || !current) return
        const isM3U8 = /\.m3u8($|\?)/i.test(current.url)
        const canNative = v.canPlayType('application/vnd.apple.mpegURL')
        if(isM3U8 && !canNative && window.Hls && window.Hls.isSupported()){
          const hls = new Hls({ maxBufferLength: 30 })
          hls.loadSource(current.url)
          hls.attachMedia(v)
          setHlsObj(hls)
        }else{ v.src = current.url }
        v.play().catch(()=>{})
      },[current])

      return e('div', { className:'bg-black min-h-screen flex flex-col' },
        e(TopBar),
        e('div', { className:'bg-zinc-900/60 px-4 py-3 flex items-center justify-between' },
          e('button', { onClick:()=>setView('channels'), className:'text-white hover:text-purple-400 flex items-center gap-2' }, '← Voltar'),
          e('h2', { className:'text-white font-semibold truncate max-w-[60vw]' }, current?.name || 'Reprodução'),
          e('div', { className:'w-10' })
        ),
        e('div', { className:'flex-1 grid place-items-center p-4' },
          e('video', { ref:videoRef, controls:true, playsInline:true, className:'w-full max-w-6xl rounded-lg bg-black' })
        )
      )
    }

    function Config(){
      return e('div', { className:'star-bg min-h-screen grid place-items-center p-4' },
        e('div', { className:'frost rounded-2xl p-6 w-full max-w-md' },
          e('h2', { className:'text-white text-2xl font-bold mb-4 text-center' }, 'Configuração API Xtream Codes'),
          e('div', { className:'space-y-3' },
            e('div', null, e('label', { className:'text-white text-sm mb-2 block' }, 'Servidor (URL:Porta)'),
              e('input', { type:'text', value:cfg.server, placeholder:'http://seu-servidor:8080', onChange:(ev)=>setCfg(v=>({...v,server:ev.target.value})), className:'w-full frost text-white px-4 py-3 rounded-lg focus:outline-none placeholder:text-gray-400' })
            ),
            e('div', null, e('label', { className:'text-white text-sm mb-2 block' }, 'Usuário'),
              e('input', { type:'text', value:cfg.username, onChange:(ev)=>setCfg(v=>({...v,username:ev.target.value})), className:'w-full frost text-white px-4 py-3 rounded-lg focus:outline-none' })
            ),
            e('div', null, e('label', { className:'text-white text-sm mb-2 block' }, 'Senha'),
              e('input', { type:'password', value:cfg.password, onChange:(ev)=>setCfg(v=>({...v,password:ev.target.value})), className:'w-full frost text-white px-4 py-3 rounded-lg focus:outline-none' })
            ),
            e('label', { className:'text-white/90 text-xs flex items-center gap-2' },
              e('input', { type:'checkbox', checked:useProxy, onChange:(ev)=>setUseProxy(!!ev.target.checked) }),
              'Usar proxy CORS (AllOrigins) — somente para testes (expõe credenciais ao serviço proxy)'
            ),
            e('button', { onClick:onConnect, className:'w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all' }, 'Conectar'),
            error && e('div', { className:'text-red-300 text-xs mt-2' },
              e('div', null, error),
              debug? e('div', {className:'hint text-gray-400 mt-1'}, 'URL: ', maskUrlCredentials(debug.url||'')) : null
            )
          ),
          account && e('div', { className:'text-green-300 text-sm mt-3' }, 'Conectado como ', account.username)
        )
      )
    }

    // ===== Router =====
    if(view==='config') return e(Config)
    if(view==='home') return e(Home)
    if(view.endsWith('-categories')) return e(Categories)
    if(view==='channels' && selectedCat) return e(Channels)
    if(view==='player' && current) return e(Player)
    return e('div', { className:'star-bg min-h-screen grid place-items-center text-white' }, 'Carregando...')
  }

  const root = ReactDOM.createRoot(document.getElementById('app'))
  root.render(e(App))

  // ===== Pequenos testes =====
  ;(function runTests(){
    const tests = []
    function assert(name, cond){ tests.push([name, !!cond]) }
    try{
      assert('sanitizeServer adiciona http', sanitizeServer('example.com')==='http://example.com')
      assert('sanitizeServer remove barra final', sanitizeServer('http://a.com/')==='http://a.com')
      assert('sanitizeServer mantém https', sanitizeServer('https://a.com').startsWith('https://'))
      assert('buildURL concatena segmentos', buildURL('http://a.com', ['x','y'])==='http://a.com/x/y')
      assert('buildURL remove barras extras', buildURL('http://a.com/', ['/x/','/y/'])==='http://a.com/x/y')
      assert('formatEPGTime string HH:MM', formatEPGTime('08:30')==='08:30')
      const nowSec = Math.floor(Date.now()/1000)
      assert('formatEPGTime timestamp s/ms', /\d{2}:\d{2}/.test(formatEPGTime(nowSec)) && /\d{2}:\d{2}/.test(formatEPGTime(nowSec*1000)))
      assert('maskUrlCredentials oculta user/pass (qs)', /\*\*\*/.test(maskUrlCredentials('http://x/player_api.php?username=u&password=p')))
      // Normalizadores
      assert('toArray aceita array', Array.isArray(toArray([{a:1}])))
      assert('toArray aceita objeto-indexado', Array.isArray(toArray({0:{a:1},1:{a:2}})))
      assert('getCatId cobre vários campos', getCatId({category_id:123})===123 && getCatId({id:9})===9)
      // Proxy wrapper
      const u='http://a.com/player_api.php?x=1'
      assert('wrapProxy off mantém URL', wrapProxy(u,false)===u)
      assert('wrapProxy on envolve URL', wrapProxy(u,true).startsWith('https://api.allorigins.win/raw?url='))
      // Extras
      assert('toArray(null) => []', Array.isArray(toArray(null)) && toArray(null).length===0)
      assert('getCatId CategoryID/categoryid', getCatId({CategoryID:7})===7 && getCatId({categoryid:8})===8)
      assert('maskUrlCredentials mascara path credenciais', !(/\/live\/[\w-]+\/[\w-]+\//.test(maskUrlCredentials('http://x/live/u/p/999.m3u8'))))
      assert('formatEPGTime inválido => "--:--"', formatEPGTime('abc')==='--:--' && formatEPGTime(null)==='--:--')
    }catch(err){ console.error('Tests crashed:', err) }
    const passed = tests.filter(t=>t[1]).length
    if(tests.length){ console.info(`[DevTests] ${passed}/${tests.length} passed`, tests) }
  })()
  </script>
</body>
</html>
